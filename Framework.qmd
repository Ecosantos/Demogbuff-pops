---
title: "Population responses to environmental stochasticity are primarily driven by survival-reproduction trade-offs and mediated by aridity"
author:
  - name: Gabriel S. Santos
    orcid: 0000-0001-7991-8807
    email: ssantos.gabriel@gmail.com
    affiliations:
      - name: Afiliação 1
      - name: Instituto Nacional da Mata Atlântica
date: last-modified
date-format: "[Last compiled on] D MMMM, YYYY - HH:mm[h]"
format: 
  html:
    code-fold: show  # Determine code collapsed 
    engine: knitr
editor: visual
toc: true
toc-location: left
execute:
  cache: false        #Chck if it is always works well
knitr:
  opts_chunk:
    comment: "#>"
    collapse: true
reference-location: margin
citation-location: margin
tags:
  - Demographic buffering
---

```{css, echo = FALSE}
.output {
max-height: 500px;
overflow-y: scroll;
}
```

# README

The following script provide the general framework used to analyse demographic buffering continuum in Santos et al. in review: Population responses to environmental stochasticity are primarily driven by survival-reproduction trade-offs and mediated by aridity

Intermediary code and data steps are sourced along the framework Intermediary code and data include:

1.  Data cleaning and selection and its intermediary data
2.  Life history traits calculation and its intermediary data
3.  Climatic variables calculation
4.  Analyses with MCMCglmm
5.  Core function: Stochastic elasticities of variance

## Settings

```{r message=FALSE, warning=FALSE}
#Packages
library(tidyverse)	#v2.0.0
library(popbio)		#v2.7		
library(popdemo)		#v1.3.1
library(ggplot2)		#v3.5.0
library(scales)		#v1.3.0
library(tidyr)		#v1.3.0
library(viridis)		#v0.6.3
library(FactoMineR)	#v2.8
library(factoextra)	#v1.0.7
library(Rcompadre)	#v1.2.1
library(Rage)		#v1.4.0
library(vegan)		#v2.6.4
library(rstatix)		#0.7.2
library(Rmosaic) ; # remotes::install_github("mosaicdatabase/Rmosaic")
library(tidybayes)	#v3.0.6
library(treeio)		#v1.24.1   DOI: 10.18129/B9.bioc.treeio
library(ggtree)		#DOI: 10.18129/B9.bioc.ggtree
library(MCMCglmm)		#v2.35

rm(list=ls())   #Cleam memory
gc()            #Clean memory


DataDir<-"/Data"
```

```{r include=FALSE}
library(kableExtra)
```

## Session Info and loaded packages

```{r echo=FALSE}

sessionInfo()

#cbind(unlist(loadedNamespaces()),
#  unlist(lapply(
#	lapply(loadedNamespaces(),packageVersion),
#		as.character)))%>%
#		data.frame()%>%arrange(-desc(X1))%>%
#   setNames(c("Package", "Version"))%>%
#  knitr::kable()%>%
#  scroll_box(width = "100%", height = "200px")

```

# Step 1 - Load data and cleaning

COMPADRE, COMADRE and MOSAIC data selection and cleaning

Produce two datasets:

1.  `CleanData`:
    -   Filter matrix singularity,
    -   presence of fecundity,
    -   individual matrices only
    -   Noncaptive populations
    -   Check ergodicity
    -   Subset variables to make improve readability
    -   Remove data without phylogenetic correspondence in supertree
2.  `supertree`
    -   Extract supertree from MOSAIC database (Bernard et al. 2023 Scientific Data).

```{r eval=FALSE, include=TRUE}
source("1 - Data cleaning and selection.R")
#file.edit("1 - Data cleaning and selection.R")
```

```{r}

# Load cleaned data
CleanData<-readRDS("Data/CleanData.RDS")
supertree<-readRDS("Data/supertree.RDS")

Metadata<-CleanData$Metadata
MetadataClean<-CleanData$MetadataClean

#Reduce (more) data to improve redability
MetadataFinal<-MetadataClean%>%select(-c(lambda,Ecoregion,Binomial))

MetadataFinal<-MetadataFinal%>%
	left_join(.,
			Metadata%>%select(ID,StudyStart, StudyDuration, StudyEnd)%>%distinct(),
				by="ID")

rm(CleanData)	#Remove non-used data

```

```{r}
MetadataFinal%>% kable %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "500px", height = "200px")
```

# Step 2 - Life history traits

Calculate life-history traits from populations filtered in `CleanData`. Also, calculate Mahalanobis distance and identify outliers.

Life-history metrics calculated

-   $L_{a}$ = mean age at first reproduction
-   $L_a prop$ = probability of achieving reproductive maturity
-   $e$ = mean life expectancy
-   shape_surv ( $H$)= Shape of survirvorship - Equivalent to Keyfitz' entropy (see Capdevila 2020 Func. Ecology https://doi.org/10.1111/1365-2435.13604
-   shape_rep( $D$ ) = Shape of reproduction - Equivalent to Demetrius' entropy (see Baudisch & Stott 2019 - https://doi.org/10.1111/2041-210X.13289
-   growth $\gamma$ =

Scripts available in `2 - Life history traits calculation.R` produces dataset `LHtraits.RDS` which is ready for the analyses

```{r eval=FALSE, include=TRUE}
source("2 - Life history traits calculation.R")
# file.edit("2 - Life history traits calculation.R")
```

Load life-history traits data and remove outliers outliers using

```{r}
LHtraits<-readRDS("Data/LHtraits.RDS")
spLHmat<-LHtraits%>%
	filter(is.outlier=="FALSE")%>%
		select(-c(is.outlier,mahal.dist))	%>%
column_to_rownames(var = "ID")

```

```{r echo=FALSE}
spLHmat%>% kable %>%
  kable_styling("striped", full_width = T) %>% 
 scroll_box(width = "500px", height = "200px")

#Correlation plot - check colinearity
#spLHmat%>%cor()%>%corrplot::corrplot(.,title="Check Colinerarity on LH traits")


```

# Step 3 - Climatic data - Extract and summarise climatic information

Two scripts are necessary :

-   3a - Climatic data extraction.R
    -   Climatic Download data and data extraction from CHELSA
        -   Because data download and information extraction is quite time consuming, an intermediary datasets are produced for each variable: Tmin, Tmax, Precipitation
-   3b - Climatic variables calculation.R
    -   Data summary and metrics extraction described in methods
    -   Produces final dataset to analyse: "climate_df.RDS"
        -   Includes: environmental trend, amplitude, and stochasticisticy

## Step 3a - Extract climatic data

Data come from Chelsacruts. An intermediary dataset containing list for all climatic layers (monthly precipitation and temperature) are available in "ChelsacrutsDataV1.xlsx"[^1]. This dataset will be used to automatize data download;

[^1]: Example of link to Chelsacruts climatic layers https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V1/chelsa_cruts/prec/CHELSAcruts_prec_10_1901_V.1.0.tif

```{r eval=FALSE, include=TRUE}
#source("3a - Climatic data extraction.R")
#file.edit("3a - Climatic data extraction.R")
```

## Step 3b - Climatic variables calculation

- Data summary and metrics extraction described in methods
- Produce final dataset to analyse: "climate_df.RDS"
- Environmental trend, amplitude, and stochasticisticy

Produces the intermediary dataset `climate_df.RDS`

```{r eval=FALSE, include=TRUE}
#source("3b - Climatic variables calculation.R")
#file.edit("3b - Climatic variables calculation.R")
climate_df<-readRDS("Data/climate_df.RDS")

```

```{r}
climate_df %>% kable %>%
  kable_styling("striped", full_width = F) %>% 
 scroll_box(width = "500px", height = "200px")
```

# Step 4 - Summarising life-history traits and climatic variables in their respectives Principal Component Analysis


## Fast-slow continuum
```{r}
LHpca<-spLHmat%>%filter(complete.cases(.))%>%PCA(.,graph=FALSE,scale=TRUE) # Using raw data without imputatation

# LHpca - Map variables
LHpca$eig%>%t()	#Explained variables
LHpca$ind$coord	#Eigenvalues
dimdesc(LHpca, axes = 1:3, proba = 0.05)

#Check PCA
cowplot::plot_grid(nrow=1,
cowplot::plot_grid(ncol=1,
fviz_eig(LHpca)+theme_bw(base_size=14),
fviz_pca(LHpca, geom=c("point"))+theme_bw(base_size=14)),
LHpca$var$cor%>%ggcorrplot::ggcorrplot(method = "circle")+theme_bw(base_size=14)+
  theme(axis.text.x=element_text(angle=75,hjust=1)))+
coord_fixed(ratio=.50)

#ggsave(file="Figures/PCALH.svg")


#Use Principal Components as variables - add to LHtraits
LHtraits<-left_join(by="ID",
	LHtraits,
	LHpca$ind$coord%>%data.frame()%>%
	rownames_to_column(var="ID")%>%as_tibble()%>%
rename_with(., ~ gsub("Dim", "LHAxis", .x, fixed = TRUE))%>%
	select(ID,LHAxis.1:LHAxis.2))%>%
filter(complete.cases(.))
```





